import logging
import os
import re
from datetime import datetime, date, timedelta, time, timezone

from telegram import (
    Update,
    ReplyKeyboardMarkup,
    ReplyKeyboardRemove,
)
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    ContextTypes,
    filters,
)

# ================== –ù–ê–°–¢–†–û–ô–ö–ò ==================

# –í–°–¢–ê–í–¨ –°–í–û–ô –¢–û–ö–ï–ù –°–Æ–î–ê –∏–ª–∏ –∑–∞–¥–∞–π –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è BOT_TOKEN –Ω–∞ Render
TOKEN = "8278378679:AAFvOBs5O5EQIHHCxSoSrkc6vgaW5ZGYFr4"

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏
MAIN_KEYBOARD = ReplyKeyboardMarkup(
    [
        ["üîÆ –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è", "üìÜ –ù–µ–¥–µ–ª—è"],
        ["‚ù§Ô∏è –õ—é–±–æ–≤—å", "üí∞ –î–µ–Ω—å–≥–∏"],
        ["üí° –°–æ–≤–µ—Ç", "‚ú® –≠–Ω–µ—Ä–≥–∏—è –¥–Ω—è"],
    ],
    resize_keyboard=True,
)

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –ø–∞–º—è—Ç–∏
# {user_id: {"birth_date": date, "life_path": int, "utc_offset": int}}
USER_SETTINGS: dict[int, dict] = {}

# –†–µ–≥—É–ª—è—Ä–∫–∏ –¥–ª—è –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏
DATE_RE = re.compile(r"^\s*(\d{1,2})[.\-/](\d{1,2})[.\-/](\d{4})\s*$")
TIME_RE = re.compile(r"^\s*(\d{1,2}):(\d{2})\s*$")

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO,
)
logger = logging.getLogger(__name__)


# ================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==================

def calc_life_path(d: date) -> int:
    """–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–µ —á–∏—Å–ª–æ –ø—É—Ç–∏: —Å—É–º–º–∏—Ä—É–µ–º –≤—Å–µ —Ü–∏—Ñ—Ä—ã –¥–∞—Ç—ã –¥–æ –æ–¥–Ω–æ–π —Ü–∏—Ñ—Ä—ã."""
    digits = [int(ch) for ch in d.strftime("%d%m%Y")]
    s = sum(digits)
    while s > 9:
        s = sum(int(ch) for ch in str(s))
    return s


def get_user_settings(user_id: int) -> dict:
    """–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø–æ–ª—É—á–∞–µ–º —Å–ª–æ–≤–∞—Ä—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    if user_id not in USER_SETTINGS:
        USER_SETTINGS[user_id] = {}
    return USER_SETTINGS[user_id]


def format_life_path_text(life_path: int) -> str:
    """–ö–æ—Ä–æ—Ç–∫–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ —á–∏—Å–ª–∞ –ø—É—Ç–∏ –¥–ª—è –ø—Ä–µ–º–∏–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∏–ª—è."""
    descriptions = {
        1: "–ª–∏–¥–µ—Ä –ø–æ –ø—Ä–∏—Ä–æ–¥–µ, —Ç—ã –∑–∞–¥–∞—ë—à—å —Ç–æ–Ω –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—à—å –¥–≤–µ—Ä–∏ —Ç—É–¥–∞, –≥–¥–µ –¥—Ä—É–≥–∏–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏—Å–º–∞—Ç—Ä–∏–≤–∞—é—Ç—Å—è.",
        2: "—Ç–æ–Ω–∫–æ —á—É–≤—Å—Ç–≤—É—é—â–∏–π –¥–∏–ø–ª–æ–º–∞—Ç: —Ä—è–¥–æ–º —Å —Ç–æ–±–æ–π –º–∏—Ä —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –º—è–≥—á–µ –∏ –≥–∞—Ä–º–æ–Ω–∏—á–Ω–µ–µ.",
        3: "—á–µ–ª–æ–≤–µ–∫ –∏–¥–µ–π –∏ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è, —Å —Ç–æ–±–æ–π –ø—Ä–æ—Å—ã–ø–∞–µ—Ç—Å—è –ª—ë–≥–∫–æ—Å—Ç—å –∏ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ.",
        4: "–æ–ø–æ—Ä–∞ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–π –¥–µ—Ä–∂–∞—Ç—Å—è –¥–æ–ª–≥–∏–µ –ø—Ä–æ–µ–∫—Ç—ã –∏ —Å–µ—Ä—å—ë–∑–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è.",
        5: "–≤–µ—á–Ω—ã–π –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å: —Ç–µ–±–µ –≤–∞–∂–Ω–æ –¥–≤–∏–∂–µ–Ω–∏–µ, —Å–≤–æ–±–æ–¥–∞ –∏ –≤–∫—É—Å –∂–∏–∑–Ω–∏.",
        6: "–ø—Ä–æ –ª—é–¥–µ–π –∏ –∑–∞–±–æ—Ç—É, —Ç–µ–±–µ –≤–∞–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å —É—é—Ç ‚Äî –∏ –≤ –¥–æ–º–µ, –∏ –≤ –¥–µ–ª–∞—Ö.",
        7: "–≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å, —Ç—ã –≤–∏–¥–∏—à—å —Ç–æ, —á—Ç–æ –¥—Ä—É–≥–∏–º –Ω–µ–æ—á–µ–≤–∏–¥–Ω–æ.",
        8: "–ø—Ä–æ –º–∞—Å—à—Ç–∞–± –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å –¥–µ–Ω—å–≥–∏ –∫–∞–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–∏–ª—ã.",
        9: "–ø—Ä–æ —Å–º—ã—Å–ª, —Å–ª—É–∂–µ–Ω–∏–µ –∏ –∫—Ä–∞—Å–æ—Ç—É, —Ç—ã —É–º–µ–µ—à—å —Å–æ–µ–¥–∏–Ω—è—Ç—å –ª—é–¥–µ–π –∏ –∏–¥–µ–∏.",
    }
    base = descriptions.get(
        life_path,
        "—á–µ–ª–æ–≤–µ–∫ —Å –æ—Å–æ–±—ã–º –≤–µ–∫—Ç–æ—Ä–æ–º, –∫–æ—Ç–æ—Ä—ã–π —Å–æ—á–µ—Ç–∞–µ—Ç –≤ —Å–µ–±–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–∏–ª—å–Ω—ã—Ö –ª–∏–Ω–∏–π.",
    )
    return f"–¢–≤–æ—ë –±–∞–∑–æ–≤–æ–µ —á–∏—Å–ª–æ –ø—É—Ç–∏: *{life_path}* ‚Äî {base}"


def generate_forecast(life_path: int, scope: str, for_week: bool = False) -> str:
    """
    –ü—Ä–æ—Å—Ç–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞.
    scope: general, love, money, advice, energy
    –î–ª—è –Ω–µ–¥–µ–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ—Ä–æ—Ç–∫—É—é —Ñ—Ä–∞–∑—É.
    """

    # –ë–∞–∑–æ–≤—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏ –ø–æ —á–∏—Å–ª–∞–º –ø—É—Ç–∏ ‚Äî —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç ¬´—á—É—Ç—å-—á—É—Ç—å¬ª –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–ª—Å—è.
    vibes = {
        1: "–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –ø–µ—Ä–≤–æ–π –∏ –Ω–µ –∂–¥–∞—Ç—å –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞",
        2: "–ø—Ä–æ—Å–∏—Ç—å –æ –ø–æ–¥–¥–µ—Ä–∂–∫–µ –∏ —Å—Ç—Ä–æ–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ",
        3: "–≥–æ–≤–æ—Ä–∏—Ç—å, –ø—Ä–æ—è–≤–ª—è—Ç—å—Å—è –∏ –¥–µ–ª–∏—Ç—å—Å—è —Å–≤–æ–∏–º–∏ –∏–¥–µ—è–º–∏",
        4: "–∑–∞–∫—Ä–µ–ø–ª—è—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ –¥–æ–≤–æ–¥–∏—Ç—å –Ω–∞—á–∞—Ç–æ–µ –¥–æ –∫–æ–Ω—Ü–∞",
        5: "–ø–æ–∑–≤–æ–ª–∏—Ç—å —Å–µ–±–µ –≥–∏–±–∫–æ—Å—Ç—å –∏ –Ω–µ–º–Ω–æ–≥–æ –∞–≤–∞–Ω—Ç—é—Ä–Ω–æ—Å—Ç–∏",
        6: "–∑–∞–±–æ—Ç–∏—Ç—å—Å—è –æ —Å–µ–±–µ –∏ –æ –±–ª–∏–∑–∫–∏—Ö –±–µ–∑ –æ—â—É—â–µ–Ω–∏—è –¥–æ–ª–≥–∞",
        7: "–∑–∞–º–µ–¥–ª–∏—Ç—å—Å—è, –ø–æ–¥—É–º–∞—Ç—å –∏ —É—Å–ª—ã—à–∞—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –≥–æ–ª–æ—Å",
        8: "–ø—Ä–∏–Ω—è—Ç—å –≤–∑—Ä–æ—Å–ª—ã–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è –±–µ–∑ —Å—É–µ—Ç—ã",
        9: "—É—Å–ª—ã—à–∞—Ç—å, —Ä–∞–¥–∏ —á–µ–≥–æ –≤—Å—ë —ç—Ç–æ, –∏ –Ω–µ –∑–∞–±—ã—Ç—å –æ –∫—Ä–∞—Å–æ—Ç–µ –ø—É—Ç–∏",
    }

    vibe = vibes.get(
        life_path,
        "–¥–µ–ª–∞—Ç—å —à–∞–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∏ —á–µ—Å—Ç–Ω—ã, –∏ –∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã —Ç–µ–±–µ",
    )

    if scope == "general":
        if for_week:
            return f"–î–µ–Ω—å –ø—Ä–æ —Ç–æ, —á—Ç–æ–±—ã {vibe}."
        return (
            "–°–µ–≥–æ–¥–Ω—è –¥–µ–Ω—å —Å –º—è–≥–∫–æ–π, –Ω–æ —Å–æ–±—Ä–∞–Ω–Ω–æ–π —ç–Ω–µ—Ä–≥–∏–µ–π.\n\n"
            "–•–æ—Ä–æ—à–∏–π –º–æ–º–µ–Ω—Ç, —á—Ç–æ–±—ã –æ–≥–ª—è–Ω—É—Ç—å—Å—è –Ω–∞ —Å–≤–æ–∏ –ø–ª–∞–Ω—ã, "
            "—á—É—Ç—å –ø–æ–¥–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫—É—Ä—Å –∏ —Å–¥–µ–ª–∞—Ç—å –æ–¥–∏–Ω-–¥–≤–∞ –æ—Å–æ–∑–Ω–∞–Ω–Ω—ã—Ö —à–∞–≥–∞, "
            "–≤–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã —Ä–∞–∑–±—Ä–∞—Å—ã–≤–∞—Ç—å—Å—è –≤ —Ä–∞–∑–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã.\n\n"
            f"–ì–ª–∞–≤–Ω—ã–π –º–æ—Ç–∏–≤ –¥–Ω—è ‚Äî {vibe}."
        )

    if scope == "love":
        if for_week:
            return "–í –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö –≤–∞–∂–Ω—ã —á–µ—Å—Ç–Ω—ã–π –¥–∏–∞–ª–æ–≥ –∏ –Ω–µ–º–Ω–æ–≥–æ –Ω–µ–∂–Ω–æ—Å—Ç–∏."
        return (
            "–í —Å—Ñ–µ—Ä–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–π –¥–µ–Ω—å –ø—Ä–æ —á–µ—Å—Ç–Ω–æ—Å—Ç—å –∏ —Ç–µ–ø–ª–æ.\n\n"
            "–ï—Å–ª–∏ –µ—Å—Ç—å —á—Ç–æ —Å–∫–∞–∑–∞—Ç—å ‚Äî —Å–∫–∞–∂–∏ –º—è–≥–∫–æ, –Ω–æ –ø–æ —Å—É—â–µ—Å—Ç–≤—É. "
            "–ï—Å–ª–∏ —Ä—è–¥–æ–º –µ—Å—Ç—å —á–µ–ª–æ–≤–µ–∫, –∫ –∫–æ—Ç–æ—Ä–æ–º—É —Ç—è–Ω–µ—Ç—Å—è —Å–µ—Ä–¥—Ü–µ, ‚Äî "
            "–¥–∞–π –µ–º—É —á—É—Ç—å –±–æ–ª—å—à–µ –≤–Ω–∏–º–∞–Ω–∏—è, —á–µ–º –æ–±—ã—á–Ω–æ.\n\n"
            "–ù–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Ä–µ—à–∞—Ç—å –≤—Å—ë —Å—Ä–∞–∑—É. –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ–¥–Ω–æ–≥–æ –º–∞–ª–µ–Ω—å–∫–æ–≥–æ —à–∞–≥–∞ –Ω–∞–≤—Å—Ç—Ä–µ—á—É."
        )

    if scope == "money":
        if for_week:
            return "–§–∏–Ω–∞–Ω—Å—ã –±–ª–∞–≥–æ–¥–∞—Ä–Ω—ã –∑–∞ –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–µ, –≤–∑—Ä–æ—Å–ª—ã–µ —Ä–µ—à–µ–Ω–∏—è –±–µ–∑ —Ä–µ–∑–∫–∏—Ö –¥–≤–∏–∂–µ–Ω–∏–π."
        return (
            "–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —ç–Ω–µ—Ä–≥–∏—è –¥–Ω—è —Å–ø–æ–∫–æ–π–Ω–∞—è, –Ω–æ —Å–æ–±—Ä–∞–Ω–Ω–∞—è.\n\n"
            "–•–æ—Ä–æ—à–æ –∑–∞—Ö–æ–¥—è—Ç:\n"
            "‚Äî —Ä–∞–∑–±–æ—Ä —Ç—Ä–∞—Ç –∏ –ø–ª–∞—Ç–µ–∂–µ–π,\n"
            "‚Äî –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Ö–æ–¥–æ–≤,\n"
            "‚Äî –æ–¥–∏–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —à–∞–≥ –≤ —Å—Ç–æ—Ä–æ–Ω—É —Ä–æ—Å—Ç–∞, –∞ –Ω–µ —Ö–∞–æ—Ç–∏—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ ¬´—É—Å–ø–µ—Ç—å –≤—Å—ë¬ª.\n\n"
            "–°–µ–≥–æ–¥–Ω—è –ª—É—á—à–µ –≤–∫–ª–∞–¥—ã–≤–∞—Ç—å—Å—è –≤ –ø–æ–Ω—è—Ç–Ω—ã–µ —Ç–µ–±–µ —Ä–µ—à–µ–Ω–∏—è, –∞ –Ω–µ –≤ —Å–ø–æ–Ω—Ç–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã."
        )

    if scope == "advice":
        if for_week:
            return "–°–æ–≤–µ—Ç –¥–Ω—è: –±—É–¥—å –Ω–µ–º–Ω–æ–≥–æ –±–µ—Ä–µ–∂–Ω–µ–µ –∫ —Å–µ–±–µ, —á–µ–º –æ–±—ã—á–Ω–æ."
        return (
            "–°–æ–≤–µ—Ç –¥–Ω—è ‚Äî –Ω–µ –±–µ–∂–∞—Ç—å –±—ã—Å—Ç—Ä–µ–µ —Å–≤–æ–∏—Ö –æ—â—É—â–µ–Ω–∏–π.\n\n"
            "–ó–∞–º–µ—Ç—å, –≥–¥–µ —Ç—ã –¥–µ–ª–∞–µ—à—å ¬´–Ω–∞–¥–æ¬ª, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –æ—Ç–∫–ª–∏–∫, "
            "–∏ –ø–æ–ø—Ä–æ–±—É–π —Ö–æ—Ç—è –±—ã —á—É—Ç—å-—á—É—Ç—å –ø–µ—Ä–µ–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫ –≤ –ø–æ–ª—å–∑—É —Å–µ–±—è.\n\n"
            "–û–¥–∏–Ω —á–µ—Å—Ç–Ω—ã–π ¬´–Ω–µ—Ç¬ª —Å–µ–≥–æ–¥–Ω—è –º–æ–∂–µ—Ç –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –º–Ω–æ–≥–æ —ç–Ω–µ—Ä–≥–∏–∏ –∑–∞–≤—Ç—Ä–∞."
        )

    if scope == "energy":
        if for_week:
            return "–≠–Ω–µ—Ä–≥–∏—è –¥–Ω—è —Å–ø–æ–∫–æ–π–Ω–∞—è: –ª—É—á—à–µ –æ–ø–∏—Ä–∞—Ç—å—Å—è –Ω–∞ —Ä–∏—Ç–º, –∞ –Ω–µ –Ω–∞ —Ä—ã–≤–æ–∫."
        return (
            "–≠–Ω–µ—Ä–≥–∏—è –¥–Ω—è –±–æ–ª—å—à–µ –ø—Ä–æ –≥–ª—É–±–∏–Ω—É, —á–µ–º –ø—Ä–æ —Å–∫–æ—Ä–æ—Å—Ç—å.\n\n"
            "–°–µ–≥–æ–¥–Ω—è —Ö–æ—Ä–æ—à–æ –ø–æ–ª—É—á–∞–µ—Ç—Å—è —Ç–æ, —á—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è: "
            "–∫–æ–≥–¥–∞ —Ç—ã —Ç–µ–ª–æ–º, –º—ã—Å–ª—è–º–∏ –∏ —Å–µ—Ä–¥—Ü–µ–º –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ.\n\n"
            "–ü–æ–ª–µ–∑–Ω–æ —É—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –º–∞–ª–µ–Ω—å–∫–∏–µ –ø–∞—É–∑—ã ‚Äî –ø–æ –º–∏–Ω—É—Ç–µ-–¥–≤–µ ‚Äî —á—Ç–æ–±—ã –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è –∫ —Å–µ–±–µ."
        )

    # –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π, –µ—Å–ª–∏ scope –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω
    if for_week:
        return f"–î–µ–Ω—å –ø—Ä–æ —Ç–æ, —á—Ç–æ–±—ã {vibe}."
    return (
        "–°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å –ø—Ä–∏–≥–ª–∞—à–∞–µ—Ç —Ç–µ–±—è –±—ã—Ç—å –Ω–µ–º–Ω–æ–≥–æ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–µ–µ –∫ —Å–µ–±–µ, "
        "—á–µ–º –æ–±—ã—á–Ω–æ. –ü—Ä–∏—Å–ª—É—à–∏–≤–∞–π—Å—è –∫ –æ—â—É—â–µ–Ω–∏—è–º, –Ω–µ –æ–±–µ—Å—Ü–µ–Ω–∏–≤–∞–π —Å–≤–æ–∏ –∂–µ–ª–∞–Ω–∏—è, "
        "–∏ —à–∞–≥ –∑–∞ —à–∞–≥–æ–º –≤—ã—Å—Ç—Ä–∞–∏–≤–∞–π –¥–µ–Ω—å –ø–æ–¥ —Å–µ–±—è."
    )


async def schedule_daily_job(user_id: int, offset_hours: int, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–°–æ–∑–¥–∞—ë–º/–ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë–º –µ–∂–µ–¥–Ω–µ–≤–Ω—É—é —Ä–∞—Å—Å—ã–ª–∫—É –ø—Ä–æ–≥–Ω–æ–∑–∞ –≤ 7:30 –ø–æ –ª–æ–∫–∞–ª—å–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    job_queue = context.job_queue
    job_name = f"daily_{user_id}"

    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∂–æ–±—ã —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º
    for job in job_queue.get_jobs_by_name(job_name):
        job.schedule_removal()

    tz = timezone(timedelta(hours=offset_hours))

    job_queue.run_daily(
        callback=send_daily_forecast_job,
        time=time(7, 30),
        tzinfo=tz,
        name=job_name,
        data={"user_id": user_id},
    )
    logger.info("Scheduled daily job for user %s with offset %s", user_id, offset_hours)


async def send_daily_forecast_job(context: ContextTypes.DEFAULT_TYPE) -> None:
    """–§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è —à–ª—ë—Ç —É—Ç—Ä–µ–Ω–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é."""
    job_data = context.job.data or {}
    user_id = job_data.get("user_id")
    if not user_id:
        return

    settings = USER_SETTINGS.get(user_id)
    if not settings or "life_path" not in settings:
        return

    life_path = settings["life_path"]
    chat_id = user_id  # –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö —á–∞—Ç–æ–≤ id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è = id —á–∞—Ç–∞

    text = (
        "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ ‚ú®\n\n"
        "–¢–≤–æ—è –º—è–≥–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:\n\n"
        + generate_forecast(life_path, "general")
    )

    try:
        await context.bot.send_message(chat_id=chat_id, text=text)
    except Exception as e:
        logger.warning("Failed to send daily forecast to %s: %s", user_id, e)


# ================== –•–ï–ù–î–õ–ï–†–´ ==================

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user = update.effective_user
    user_id = user.id
    settings = get_user_settings(user_id)

    greeting = (
        "–ü—Ä–∏–≤–µ—Ç! –Ø ‚Äî —Ç–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç üåø\n\n"
        "–ö–∞–∂–¥—ã–π –¥–µ–Ω—å —è –±—É–¥—É –ø–æ–º–æ–≥–∞—Ç—å —Ç–µ–±–µ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å—Å—è –Ω–∞ –≤–µ—Ä–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, "
        "–≤–∏–¥–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏ –º—è–≥–∫–æ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞—Ç—å, –≥–¥–µ —Å–µ–≥–æ–¥–Ω—è –ª—É—á—à–µ –ø—Ä–æ—è–≤–∏—Ç—å—Å—è, –∞ –≥–¥–µ ‚Äî –ø—Ä–∏—Ç–æ—Ä–º–æ–∑–∏—Ç—å.\n\n"
        "–ß—Ç–æ–±—ã –º–æ–∏ –ø—Ä–æ–≥–Ω–æ–∑—ã —Ç–æ—á–Ω–µ–µ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–ª–∏—Å—å –ø–æ–¥ —Ç–≤–æ–π –ø—É—Ç—å, "
        "–Ω–∞–ø–∏—à–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, *–¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è* –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n"
        "`–î–î.MM.–ì–ì–ì–ì`\n\n"
        "–ù–∞–ø—Ä–∏–º–µ—Ä: `23.06.1993`.\n\n"
        "–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —è –ø–æ–ø—Ä–æ—à—É —Ç–µ–±—è –µ—â—ë –ø–æ–¥—Å–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è, "
        "—á—Ç–æ–±—ã –≤ 7:30 –∏–º–µ–Ω–Ω–æ —Ç–≤–æ–µ–≥–æ —É—Ç—Ä–∞ –ø—Ä–∏—Å—ã–ª–∞—Ç—å —Ç–µ–±–µ –Ω–µ–±–æ–ª—å—à—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É –Ω–∞ –¥–µ–Ω—å üíõ"
    )

    await update.message.reply_text(
        greeting,
        parse_mode="Markdown",
        reply_markup=MAIN_KEYBOARD,
    )

    # –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –µ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Äî –Ω–∞–ø–æ–º–Ω–∏–º, —á—Ç–æ –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –∂–∞—Ç—å –∫–Ω–æ–ø–∫–∏
    if settings.get("life_path"):
        await update.message.reply_text(
            "–ê –µ—â—ë —Ç—ã –º–æ–∂–µ—à—å –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç –Ω–∞–∂–∞—Ç—å –æ–¥–Ω—É –∏–∑ –∫–Ω–æ–ø–æ–∫ –Ω–∏–∂–µ, "
            "—á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è, –Ω–∞ –Ω–µ–¥–µ–ª—é –∏–ª–∏ –ø–æ –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å—Ñ–µ—Ä–∞–º üåü",
            reply_markup=MAIN_KEYBOARD,
        )


async def today(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è (–æ–±—â–∏–π)."""
    user_id = update.effective_user.id
    settings = get_user_settings(user_id)
    life_path = settings.get("life_path", 5)  # –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —á—Ç–æ-—Ç–æ –∂–∏–≤–æ–µ

    text = "üîÆ *–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è*\n\n" + generate_forecast(life_path, "general")
    await update.message.reply_text(text, parse_mode="Markdown")


async def love(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_user.id
    settings = get_user_settings(user_id)
    life_path = settings.get("life_path", 5)

    text = "‚ù§Ô∏è *–õ—é–±–æ–≤—å –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è*\n\n" + generate_forecast(life_path, "love")
    await update.message.reply_text(text, parse_mode="Markdown")


async def money(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_user.id
    settings = get_user_settings(user_id)
    life_path = settings.get("life_path", 5)

    text = "üí∞ *–î–µ–Ω—å–≥–∏ –∏ –¥–µ–ª–∞*\n\n" + generate_forecast(life_path, "money")
    await update.message.reply_text(text, parse_mode="Markdown")


async def advice(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_user.id
    settings = get_user_settings(user_id)
    life_path = settings.get("life_path", 5)

    text = "üí° *–°–æ–≤–µ—Ç –¥–Ω—è*\n\n" + generate_forecast(life_path, "advice")
    await update.message.reply_text(text, parse_mode="Markdown")


async def energy(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_user.id
    settings = get_user_settings(user_id)
    life_path = settings.get("life_path", 5)

    text = "‚ú® *–≠–Ω–µ—Ä–≥–∏—è –¥–Ω—è*\n\n" + generate_forecast(life_path, "energy")
    await update.message.reply_text(text, parse_mode="Markdown")


async def week(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ö–æ—Ä–æ—Ç–∫–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –±–ª–∏–∂–∞–π—à—É—é –Ω–µ–¥–µ–ª—é."""
    user_id = update.effective_user.id
    settings = get_user_settings(user_id)
    life_path = settings.get("life_path", 5)

    today_date = date.today()
    lines = ["üìÜ *–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –Ω–µ–¥–µ–ª—é*\n"]
    for i in range(7):
        d = today_date + timedelta(days=i)
        weekday = d.strftime("%a").replace("Mon", "–ü–Ω").replace("Tue", "–í—Ç").replace("Wed", "–°—Ä") \
            .replace("Thu", "–ß—Ç").replace("Fri", "–ü—Ç").replace("Sat", "–°–±").replace("Sun", "–í—Å")
        short = generate_forecast(life_path, "general", for_week=True)
        lines.append(f"*{weekday} {d.strftime('%d.%m')}:* {short}")

    await update.message.reply_text("\n".join(lines), parse_mode="Markdown")


async def handle_text(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –ì–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±—ã—á–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞:
    ‚Äî –∫–Ω–æ–ø–∫–∏,
    ‚Äî –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è –±–µ–∑ /birth,
    ‚Äî –≤—Ä–µ–º—è ¬´–∫–æ—Ç–æ—Ä—ã–π —Å–µ–π—á–∞—Å —á–∞—Å?¬ª,
    ‚Äî –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ.
    """
    if not update.message:
        return

    text = update.message.text.strip()
    user_id = update.effective_user.id
    settings = get_user_settings(user_id)

    # ---- 1. –ö–Ω–æ–ø–∫–∏ ----
    if text == "üîÆ –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è":
        await today(update, context)
        return
    if text == "üìÜ –ù–µ–¥–µ–ª—è":
        await week(update, context)
        return
    if text == "‚ù§Ô∏è –õ—é–±–æ–≤—å":
        await love(update, context)
        return
    if text == "üí∞ –î–µ–Ω—å–≥–∏":
        await money(update, context)
        return
    if text == "üí° –°–æ–≤–µ—Ç":
        await advice(update, context)
        return
    if text == "‚ú® –≠–Ω–µ—Ä–≥–∏—è –¥–Ω—è":
        await energy(update, context)
        return

    # ---- 2. –ï—Å–ª–∏ —ç—Ç–æ –ø–æ—Ö–æ–∂–µ –Ω–∞ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è ----
    m_date = DATE_RE.match(text)
    if m_date:
        day, month, year = map(int, m_date.groups())
        try:
            bdate = date(year, month, day)
        except ValueError:
            await update.message.reply_text(
                "–ö–∞–∂–µ—Ç—Å—è, –≤ –¥–∞—Ç–µ —á—Ç–æ-—Ç–æ –ø–µ—Ä–µ–ø—É—Ç–∞–Ω–æ. –ù–∞–ø–∏—à–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è –µ—â—ë —Ä–∞–∑ –≤ —Ñ–æ—Ä–º–∞—Ç–µ `–î–î.MM.–ì–ì–ì–ì` üíõ",
                parse_mode="Markdown",
            )
            return

        settings["birth_date"] = bdate
        life_path = calc_life_path(bdate)
        settings["life_path"] = life_path

        lp_text = format_life_path_text(life_path)

        await update.message.reply_text(
            f"–°–æ—Ö—Ä–∞–Ω–∏–ª–∞ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è: *{bdate.strftime('%d.%m.%Y')}*.\n\n{lp_text}\n\n"
            "–¢–µ–ø–µ—Ä—å –º–æ–∏ –ø—Ä–æ–≥–Ω–æ–∑—ã –±—É–¥—É—Ç –º—è–≥—á–µ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞—Ç—å—Å—è –∏–º–µ–Ω–Ω–æ –ø–æ–¥ —Ç–≤–æ–π –ø—É—Ç—å üåø",
            parse_mode="Markdown",
        )

        # –ï—Å–ª–∏ –µ—â—ë –Ω–µ—Ç —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ ‚Äî –º—è–≥–∫–æ –ø—Ä–æ—Å–∏–º –≤—Ä–µ–º—è
        if "utc_offset" not in settings:
            await update.message.reply_text(
                "–ò –µ—â—ë –æ–¥–Ω–∞ –º–∞–ª–µ–Ω—å–∫–∞—è –ø—Ä–æ—Å—å–±–∞ ‚ú®\n\n"
                "–ù–∞–ø–∏—à–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, *–∫–æ—Ç–æ—Ä—ã–π —É —Ç–µ–±—è —Å–µ–π—á–∞—Å —á–∞—Å*, –≤ —Ñ–æ—Ä–º–∞—Ç–µ `–ß–ß:–ú–ú`.\n\n"
                "–ù–∞–ø—Ä–∏–º–µ—Ä: `14:25`.\n"
                "–¢–∞–∫ —è —Å–º–æ–≥—É –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–≤–æ—é —É—Ç—Ä–µ–Ω–Ω—é—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É –ø—Ä–∏–º–µ—Ä–Ω–æ –≤ *7:30 —Ç–≤–æ–µ–≥–æ —É—Ç—Ä–∞* üíõ",
                parse_mode="Markdown",
            )
        return

    # ---- 3. –ï—Å–ª–∏ —ç—Ç–æ –ø–æ—Ö–æ–∂–µ –Ω–∞ –≤—Ä–µ–º—è (–∫–æ—Ç–æ—Ä—ã–π —Å–µ–π—á–∞—Å —á–∞—Å) ----
    m_time = TIME_RE.match(text)
    if m_time:
        hour_local, minute_local = map(int, m_time.groups())
        if not (0 <= hour_local <= 23 and 0 <= minute_local <= 59):
            await update.message.reply_text(
                "–ö–∞–∂–µ—Ç—Å—è, –≤—Ä–µ–º—è –Ω–µ–º–Ω–æ–≥–æ –≤—ã–±–∏–≤–∞–µ—Ç—Å—è –∏–∑ —Ñ–æ—Ä–º–∞—Ç–∞. –ù–∞–ø–∏—à–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—Ä–µ–º—è –≤ –≤–∏–¥–µ `–ß–ß:–ú–ú`, –Ω–∞–ø—Ä–∏–º–µ—Ä `09:15`.",
                parse_mode="Markdown",
            )
            return

        # –¢–µ–∫—É—â–µ–µ UTC –≤—Ä–µ–º—è
        now_utc = datetime.now(timezone.utc)
        # –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–π —Å–¥–≤–∏–≥ –≤ —á–∞—Å–∞—Ö
        offset_hours = hour_local - now_utc.hour
        # –ü—Ä–∏–≤–æ–¥–∏–º –∫ –¥–∏–∞–ø–∞–∑–æ–Ω—É -12..+14
        while offset_hours < -12:
            offset_hours += 24
        while offset_hours > 14:
            offset_hours -= 24

        settings["utc_offset"] = offset_hours

        await update.message.reply_text(
            f"–ü—Ä–∏–Ω—è–ª–∞. –ë—É–¥—É —Å—á–∏—Ç–∞—Ç—å, —á—Ç–æ —Ç—ã –ø—Ä–∏–º–µ—Ä–Ω–æ –≤ –∑–æ–Ω–µ `UTC{offset_hours:+d}` ‚è∞\n\n"
            "–¢–µ–ø–µ—Ä—å —è —Å–º–æ–≥—É –ø—Ä–∏—Å—ã–ª–∞—Ç—å —Ç–µ–±–µ —É—Ç—Ä–µ–Ω–Ω—é—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É –ø—Ä–∏–º–µ—Ä–Ω–æ –≤ *7:30 —Ç–≤–æ–µ–≥–æ —É—Ç—Ä–∞*.\n\n"
            "–ï—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å, –º—ã –≤—Å–µ–≥–¥–∞ —Å–º–æ–∂–µ–º –ø–æ–¥–ø—Ä–∞–≤–∏—Ç—å –≤—Ä–µ–º—è –ø–æ–∑–∂–µ üíõ",
            parse_mode="Markdown",
        )

        # –°—Ç–∞–≤–∏–º –µ–∂–µ–¥–Ω–µ–≤–Ω—É—é —Ä–∞—Å—Å—ã–ª–∫—É
        await schedule_daily_job(user_id, offset_hours, context)
        return

    # ---- 4. –ï—Å–ª–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç ----

    # –ï—Å–ª–∏ –µ—â—ë –Ω–µ—Ç –¥–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è ‚Äî –º—è–≥–∫–æ –Ω–∞–ø–æ–º–∏–Ω–∞–µ–º
    if "birth_date" not in settings:
        await update.message.reply_text(
            "–•–æ—á—É –¥–∞—Ç—å —Ç–µ–±–µ –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑, –Ω–æ –º–Ω–µ –ø–æ–∫–∞ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è üåø\n\n"
            "–ù–∞–ø–∏—à–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ `–î–î.MM.–ì–ì–ì–ì`.\n"
            "–ù–∞–ø—Ä–∏–º–µ—Ä: `23.06.1993`.",
            parse_mode="Markdown",
            reply_markup=MAIN_KEYBOARD,
        )
        return

    # –ï—Å–ª–∏ –¥–∞—Ç–∞ –µ—Å—Ç—å, –Ω–æ –Ω–µ—Ç –≤—Ä–µ–º–µ–Ω–∏
    if "utc_offset" not in settings:
        await update.message.reply_text(
            "–ß—Ç–æ–±—ã —É—Ç—Ä–µ–Ω–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏—Ö–æ–¥–∏–ª–∏ –≤–æ–≤—Ä–µ–º—è, –Ω–∞–ø–∏—à–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π —É —Ç–µ–±—è —Å–µ–π—á–∞—Å —á–∞—Å ‚Äî –≤ —Ñ–æ—Ä–º–∞—Ç–µ `–ß–ß:–ú–ú`.\n\n"
            "–ù–∞–ø—Ä–∏–º–µ—Ä: `08:05`.",
            parse_mode="Markdown",
        )
        return

    # –ò–Ω–∞—á–µ –ø—Ä–æ—Å—Ç–æ –ø–æ–¥—Å–∫–∞–∂–µ–º, —á—Ç–æ –¥–µ–ª–∞—Ç—å
    await update.message.reply_text(
        "–Ø –ø–æ–∫–∞ –Ω–µ –¥–æ –∫–æ–Ω—Ü–∞ –ø–æ–Ω—è–ª–∞ –∑–∞–ø—Ä–æ—Å, –Ω–æ —É–∂–µ –≥–æ—Ç–æ–≤–∞ –ø–æ–º–æ—á—å üíõ\n\n"
        "–ú–æ–∂–µ—à—å:\n"
        "‚Äî –Ω–∞–∂–∞—Ç—å –æ–¥–Ω—É –∏–∑ –∫–Ω–æ–ø–æ–∫ –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑,\n"
        "‚Äî –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.",
        reply_markup=MAIN_KEYBOARD,
    )


# ================== –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ==================

def main() -> None:
    if not TOKEN or TOKEN == "PASTE_YOUR_TOKEN_HERE":
        raise RuntimeError("–ù—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π TOKEN –∏–ª–∏ BOT_TOKEN.")

    application = Application.builder().token(TOKEN).build()

    # –ö–æ–º–∞–Ω–¥—ã
    application.add_handler(CommandHandler("start", start))

    # –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–∫–Ω–æ–ø–∫–∏, –¥–∞—Ç—ã, –≤—Ä–µ–º—è, –ø—Ä–æ—á–µ–µ)
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text))

    logger.info("Bot started")
    application.run_polling()


if __name__ == "__main__":
    main()
